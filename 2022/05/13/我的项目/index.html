<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>我的项目 | Reex</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="开发社区首页——分页查询帖子功能1.创建实体类对象DiscussPost先创建一个DiscussPost的实体类对象，与之对应的数据库数据是discuss_post 分别把id, userId, title, content, type, status, createTime, commentCount, score变量及其get, set方法, toString()方法定义出来。 2.开发DAO">
<meta property="og:type" content="article">
<meta property="og:title" content="我的项目">
<meta property="og:url" content="http://example.com/2022/05/13/%E6%88%91%E7%9A%84%E9%A1%B9%E7%9B%AE/index.html">
<meta property="og:site_name" content="Reex">
<meta property="og:description" content="开发社区首页——分页查询帖子功能1.创建实体类对象DiscussPost先创建一个DiscussPost的实体类对象，与之对应的数据库数据是discuss_post 分别把id, userId, title, content, type, status, createTime, commentCount, score变量及其get, set方法, toString()方法定义出来。 2.开发DAO">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518210741410.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518211922078.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518212611807.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518213026318.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518213714266.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518214006254.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518214038726.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518221058302.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220519161309172.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220519185233228.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220519185721410.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220519190503946.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220519201235211.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220519204318213.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220519215357488.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220520165750148.png">
<meta property="og:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220520170844188.png">
<meta property="article:published_time" content="2022-05-13T12:30:20.000Z">
<meta property="article:modified_time" content="2022-05-20T11:26:45.301Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/Reex/AppData/Roaming/Typora/typora-user-images/image-20220518210741410.png">
  
    <link rel="alternate" href="/atom.xml" title="Reex" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.1.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Reex</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-我的项目" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/05/13/%E6%88%91%E7%9A%84%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time class="dt-published" datetime="2022-05-13T12:30:20.000Z" itemprop="datePublished">2022-05-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      我的项目
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="开发社区首页——分页查询帖子功能"><a href="#开发社区首页——分页查询帖子功能" class="headerlink" title="开发社区首页——分页查询帖子功能"></a>开发社区首页——分页查询帖子功能</h1><h2 id="1-创建实体类对象DiscussPost"><a href="#1-创建实体类对象DiscussPost" class="headerlink" title="1.创建实体类对象DiscussPost"></a>1.创建实体类对象DiscussPost</h2><p>先创建一个DiscussPost的实体类对象，与之对应的数据库数据是discuss_post</p>
<p>分别把id, userId, title, content, type, status, createTime, commentCount, score变量及其get, set方法, toString()方法定义出来。</p>
<h2 id="2-开发DAO层——DiscussPostMapper"><a href="#2-开发DAO层——DiscussPostMapper" class="headerlink" title="2.开发DAO层——DiscussPostMapper"></a>2.开发DAO层——DiscussPostMapper</h2><p>首先定义一个查询帖子信息的方法selectDiscussPosts，形参包括userId, offset, limit，其中userId在后面个人主页的帖子才需要，offset是每一页起始行的行号，limit是每一页最多显示多少数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;DiscussPost&gt; <span class="title function_">selectDiscussPosts</span><span class="params">(<span class="meta">@Param(&quot;userId&quot;)</span> <span class="type">int</span> userId, <span class="meta">@Param(&quot;offset&quot;)</span> <span class="type">int</span> offset, <span class="meta">@Param(&quot;limit&quot;)</span> <span class="type">int</span> limit)</span>;</span><br></pre></td></tr></table></figure>

<p>为了方便显示页码，还要定义一个方法selectDiscussPostRows来查询一共多少行帖子，只有一个形参userId，同理，也是在后面个人主页帖子的时候才需要这个userId</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">selectDiscussPostRows</span><span class="params">(<span class="type">int</span> userId)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="3-配置文件——discusspost-mapper-xml"><a href="#3-配置文件——discusspost-mapper-xml" class="headerlink" title="3.配置文件——discusspost-mapper.xml"></a>3.配置文件——discusspost-mapper.xml</h2><p>在mapper配置文件里定义一个discusspost-mapper.xml，在&lt;mapper 标签里的namespace参数写上配置文件<strong>为具体哪个接口服务</strong>的。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.nowcoder.community.dao.DiscussPostMapper&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>具体sql语句如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span></span><br><span class="line">       id, user_id, title, content, type, status, create_time, comment_count, score</span><br><span class="line">   <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectDiscussPosts&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;DiscussPost&quot;</span>&gt;</span></span><br><span class="line">       select <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;selectFields&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">       from discuss_post</span><br><span class="line">       where status != 2</span><br><span class="line">       <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId!=0&quot;</span>&gt;</span></span><br><span class="line">           and user_id = #&#123;userId&#125;</span><br><span class="line">       <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">       order by type desc, create_time desc</span><br><span class="line">       limit #&#123;offset&#125;, #&#123;limit&#125;</span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectDiscussPostRows&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">       select count(id)</span><br><span class="line">       from discuss_post</span><br><span class="line">       where status != 2</span><br><span class="line">       <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;userId!=0&quot;</span>&gt;</span></span><br><span class="line">           and user_id = #&#123;userId&#125;</span><br><span class="line">       <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="4-开发Service层——DiscussPostService和UserService"><a href="#4-开发Service层——DiscussPostService和UserService" class="headerlink" title="4.开发Service层——DiscussPostService和UserService"></a>4.开发Service层——DiscussPostService和UserService</h2><p>DiscussPostService很简单，直接调用DAO层的DiscussPostMapper的两个方法即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscussPostService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostMapper discussPostMapper;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;DiscussPost&gt; <span class="title function_">findDiscussPosts</span><span class="params">(<span class="type">int</span> userId, <span class="type">int</span> offset, <span class="type">int</span> limit)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> discussPostMapper.selectDiscussPosts(userId, offset, limit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">findDiscussPostRows</span><span class="params">(<span class="type">int</span> userId)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> discussPostMapper.selectDiscussPostRows(userId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>UserService是用来开发<strong>根据用户id来查询用户的功能</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;<span class="comment">//用于管理User类方法的dao层Mapper组件</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">findUserById</span><span class="params">(<span class="type">int</span> id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-开发Controller层——HomeController"><a href="#5-开发Controller层——HomeController" class="headerlink" title="5.开发Controller层——HomeController"></a>5.开发Controller层——HomeController</h2><p>因为这一层要用到SpringMVC，方法需要用@RequestMapping()编写访问路径，因为访问的是首页，所以路径是&#x2F;index，请求方式因为是查询，所以是RequestMethod.GET，<strong>返回的是相应的网页，所以不要加ResponseBody</strong>，直接返回String，即视图的名字。</p>
<p>形参写入Model model，因为我们要通过model携带数据传给模板，最终返回的也是模板的路径，即Templates下的index.html</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HomeController</span> <span class="keyword">implements</span> <span class="title class_">CommunityConstant</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DiscussPostService discussPostService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(path = &quot;/index&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getIndexPage</span><span class="params">(Model model, Page page)</span>&#123;</span><br><span class="line">		</span><br><span class="line">        <span class="comment">//方法调用前，SpringMVC会自动实例化Model和Page，并将Page注入Model，所以在thymeleaf中可以直接访问Page对象的数据</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取帖子的总行数</span></span><br><span class="line">        page.setRows(discussPostService.findDiscussPostRows(<span class="number">0</span>));</span><br><span class="line">        <span class="comment">//页面index就可以复用这个路径了</span></span><br><span class="line">        page.setPath(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//页码offset和limit就可以根据上面的数据和Page类来获取了</span></span><br><span class="line">        List&lt;DiscussPost&gt; list = discussPostService.findDiscussPosts(<span class="number">0</span>, page.getOffset(), page.getLimit());<span class="comment">//list只有id和userId，没有User的具体信息，所以我们通过定义一个map来存放每个帖子的具体信息和User对象</span></span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; discussPosts = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(list != <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">for</span>(DiscussPost post : list)&#123;<span class="comment">//要一个个遍历帖子内容</span></span><br><span class="line">                Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                map.put(<span class="string">&quot;post&quot;</span>, post);<span class="comment">//先存放帖子信息</span></span><br><span class="line">                <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.findUserById(post.getUserId());</span><br><span class="line">                map.put(<span class="string">&quot;user&quot;</span>, user);<span class="comment">//再存放User信息</span></span><br><span class="line">                discussPosts.add(map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//DispatcherServlet会自动将page装到model里面，所以不用单独添加page了</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;discussPosts&quot;</span>, discussPosts);<span class="comment">//要把数据传给model</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/index&quot;</span>;<span class="comment">//返回模板路径</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-创建实体类Page封装分页相关信息"><a href="#6-创建实体类Page封装分页相关信息" class="headerlink" title="6.创建实体类Page封装分页相关信息"></a>6.创建实体类Page封装分页相关信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Page</span> &#123;</span><br><span class="line">    <span class="comment">//当前页码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//显示上限</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">limit</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="comment">//数据总数(用于计算总页数)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> rows;</span><br><span class="line">    <span class="comment">//查询路径(用于复用分页链接)</span></span><br><span class="line">    <span class="keyword">private</span> String path;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCurrent</span><span class="params">()</span> &#123;<span class="keyword">return</span> current;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCurrent</span><span class="params">(<span class="type">int</span> current)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(current &gt;= <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="built_in">this</span>.current = current;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLimit</span><span class="params">()</span> &#123;<span class="keyword">return</span> limit;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLimit</span><span class="params">(<span class="type">int</span> limit)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(limit &gt;= <span class="number">1</span> &amp;&amp; limit &lt;= <span class="number">100</span>)&#123;</span><br><span class="line">            <span class="built_in">this</span>.limit = limit;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getRows</span><span class="params">()</span> &#123;<span class="keyword">return</span> rows;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRows</span><span class="params">(<span class="type">int</span> rows)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(rows &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">this</span>.rows = rows;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPath</span><span class="params">()</span> &#123;<span class="keyword">return</span> path;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPath</span><span class="params">(String path)</span> &#123;<span class="built_in">this</span>.path = path;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前页的起始行</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getOffset</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//current * limit - limit</span></span><br><span class="line">        <span class="keyword">return</span> (current - <span class="number">1</span>) * limit;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取总页数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTotal</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//rows / limit [+1]</span></span><br><span class="line">        <span class="keyword">if</span>(rows % limit == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> rows / limit;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> rows / limit + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取起始页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getFrom</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">from</span> <span class="operator">=</span> current - <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> from &lt; <span class="number">1</span> ? <span class="number">1</span> : from;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取结束页码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getTo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">to</span> <span class="operator">=</span> current + <span class="number">2</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">total</span> <span class="operator">=</span> getTotal();</span><br><span class="line">        <span class="keyword">return</span> to &gt; total ? total : to;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>要<strong>查询帖子就要访问数据库</strong>，与数据库打交道，那就是业务层干的活，<strong>业务层其实就是实现查询数据库的操作</strong>，所以直接调用持久层的查询方法，所以重点是DAO层写出查询方法，mapper.xml要写几个sql语句查询数据库的帖子详情。查询逻辑写好之后，DAO层直接调用mapper.xml的逻辑，然后业务层调DAO层，这样就来到了控制层。控制层其实就是调用业务层，<strong>把从数据库中查询到的帖子数据和用户数据传给model</strong>。因为帖子需要分页，所以我们最好专门写个实体类来实现分页功能，分页功能主要让起始行和每页帖子数量上限是一个变量，否则每次数据库变动了还得重新计算并填入到控制层方法的形参中。</p>
<h1 id="2-1开发邮件发送功能"><a href="#2-1开发邮件发送功能" class="headerlink" title="2.1开发邮件发送功能"></a>2.1开发邮件发送功能</h1><h2 id="1-设置邮箱，导入SpringBoot的Mail包"><a href="#1-设置邮箱，导入SpringBoot的Mail包" class="headerlink" title="1.设置邮箱，导入SpringBoot的Mail包"></a>1.设置邮箱，导入SpringBoot的Mail包</h2><p>新浪邮箱的设置里POP3&#x2F;SMTP功能开启，并启用授权码。</p>
<p>通过Maven导入spring-boot-starter-mail的包</p>
<h2 id="2-书写配置文件参数"><a href="#2-书写配置文件参数" class="headerlink" title="2.书写配置文件参数"></a>2.书写配置文件参数</h2><p>然后配置邮箱参数，在resources-application.properties中配置参数，具体参数如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MailProperties</span></span><br><span class="line"><span class="attr">spring.mail.host</span>=<span class="string">smtp.sina.com</span></span><br><span class="line"><span class="comment">#spring.mail.port=465</span></span><br><span class="line"><span class="attr">spring.mail.username</span>=<span class="string">ryn2020@sina.com</span></span><br><span class="line"><span class="attr">spring.mail.password</span>=<span class="string">21ad95cfc6c4b05e    #这里是新浪邮箱的授权码</span></span><br><span class="line"><span class="comment">#spring.mail.protocol=smtps</span></span><br><span class="line"><span class="comment">#spring.mail.properties.mail.smtp.ssl.enable=true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtl.auth</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtl.starttls.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">spring.mail.properties.mail.smtl.starttls.required</span>=<span class="string">true</span></span><br></pre></td></tr></table></figure>

<h2 id="3-创建工具类MailClient"><a href="#3-创建工具类MailClient" class="headerlink" title="3.创建工具类MailClient"></a>3.创建工具类MailClient</h2><p>然后去util包下创建一个工具类MailClient，该工具类将发邮件的任务委托给新浪邮箱去完成，相当于客户端</p>
<p>该类我们要加上@Component注解，成为一个Bean。</p>
<p>先声明一个日志，后面操作要记录日志。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MailClient.class);</span><br></pre></td></tr></table></figure>

<p>然后注入Spring的核心组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> JavaMailSender mailSender;</span><br></pre></td></tr></table></figure>

<p>因为每次系统邮箱，也就是发件人都是一样的，所以我们将发件人地址注入Spring中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;spring.mail.username&#125;&quot;)</span><span class="comment">//这里是配置文件中参数</span></span><br><span class="line"><span class="keyword">private</span> String from;</span><br></pre></td></tr></table></figure>

<p>接下来定义发送的方法，我们只需要收件人，邮件主题和内容即可，所以形参只有它们三个。</p>
<p>发邮件的关键就是把组件JavaMailSender中的MimeMessage邮件主体构建出来，用谁构建呢？帮助类MimeMessageHelper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMail</span><span class="params">(String to, String subject, String content)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//用核心组件JavaMailSender构建邮件主体message</span></span><br><span class="line">            <span class="type">MimeMessage</span> <span class="variable">message</span> <span class="operator">=</span> mailSender.createMimeMessage();</span><br><span class="line">            <span class="comment">//用帮助类构建message</span></span><br><span class="line">            <span class="type">MimeMessageHelper</span> <span class="variable">helper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeMessageHelper</span>(message);</span><br><span class="line">            <span class="comment">//向帮助类传入发件人，收件人，主体和html格式的内容</span></span><br><span class="line">            helper.setFrom(from);</span><br><span class="line">            helper.setTo(to);</span><br><span class="line">            helper.setSubject(subject);</span><br><span class="line">            helper.setText(content, <span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//再回到核心组件JavaMailSender执行Send方法发送邮件</span></span><br><span class="line">            mailSender.send(helper.getMimeMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MessagingException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;发送邮件失败：&quot;</span> + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-7开发注册功能"><a href="#2-7开发注册功能" class="headerlink" title="2.7开发注册功能"></a>2.7开发注册功能</h1><h2 id="1-开发Controller层——访问注册页面"><a href="#1-开发Controller层——访问注册页面" class="headerlink" title="1.开发Controller层——访问注册页面"></a>1.开发Controller层——访问注册页面</h2><p>直接开发控制层，设置一个跳转页面。跳转到site下的register</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220518210741410.png" alt="image-20220518210741410"></p>
<h2 id="2-开发随机字符生成和加密方法——CommunityUtil工具类"><a href="#2-开发随机字符生成和加密方法——CommunityUtil工具类" class="headerlink" title="2.开发随机字符生成和加密方法——CommunityUtil工具类"></a>2.开发随机字符生成和加密方法——CommunityUtil工具类</h2><p>导入这个包，主要目的是<strong>判断一些数据、字符串、集合空值的</strong>情况，后面会用到。</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220518211922078.png" alt="image-20220518211922078"></p>
<p>接下来去配置文件把域名配置好，其实现在就是本机地址，因为发邮件要写上目标地址要作为链接地址</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220518212611807.png" alt="image-20220518212611807"></p>
<p>因为注册要生成激活码，所以我们最好定义一个<strong>专门的方法用来生成随机字符串</strong>。而且将来上传头像，上传文件等，也要给这些资源生成随机名字，也需要这个工具。UUID.randomUUID就是Java自带的生成随机字符的方法，不过可能有“-”，所以要用空格替换。</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220518213026318.png" alt="image-20220518213026318"></p>
<p>另外注册的时候上传的<strong>密码是明文的，我们需要MD5加密</strong>。</p>
<p>为了防止一些简单字符串每次加密后的字符都一样，所以我们也可以看到数据库表中有盐salt，也就是<strong>每次给密码加盐</strong>，也就是加随机字符串，这样就避免密码的盗取。</p>
<p>加密是<strong>Spring自带的工具类DigestUtils</strong>的方法，加密前，我们用前面导入的lang3包对字符串先进性判空操作，非空字符串我们再加密（要求16进制的byte类型，所以要转一下）。</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220518213714266.png" alt="image-20220518213714266"></p>
<h2 id="3-开发Service层——UserService实现注册业务逻辑"><a href="#3-开发Service层——UserService实现注册业务逻辑" class="headerlink" title="3.开发Service层——UserService实现注册业务逻辑"></a>3.开发Service层——UserService实现注册业务逻辑</h2><p>因为注册要发邮件，所以把邮件注入进来，也注入模板引擎，后面要用。</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220518214006254.png" alt="image-20220518214006254"></p>
<p>然后还需要用到<strong>域名和项目名</strong>，也注入进来</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220518214038726.png" alt="image-20220518214038726"></p>
<p>开始写注册业务方法，因为返回值要<strong>包括好多“报错信息”，所以我们用Map</strong>，注册需要用户传入账号，密码和邮箱，所以我们传入一个User。</p>
<p>首先对形参user进行空值判断，如果<strong>是空则报异常（注意不是报错</strong>）。然后是user的具体信息，如果哪个空了，就把哪个错误记录在map里面，返回给用户看。</p>
<p>如果都不空，还要验证邮箱和用户名是不是数据库里面已经有了，所以还要<strong>有验证操作</strong>。</p>
<p>然后才开始注册用户：</p>
<p>1）先<strong>设置盐</strong>，用随机生成字符串的方法</p>
<p>2）给密码<strong>加盐</strong></p>
<p>3）设置<strong>用户类型，激活状态</strong>，然后<strong>设置激活码</strong>（还是随机生成）</p>
<p>4）给用户<strong>设置默认头像</strong>，用牛客网默认的1000个头像中随机一个</p>
<p>5）最后给用户设置一个<strong>账号创建时间</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">register</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//空值处理</span></span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;参数不能为空！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(user.getUsername()))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;账号不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(user.getPassword()))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;passwordMsg&quot;</span>, <span class="string">&quot;密码不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(user.getEmail()))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;emailMsg&quot;</span>, <span class="string">&quot;邮箱不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;<span class="comment">//这个地方第一次忘记写了，导致邮箱重复仍旧注册账户，注册后才提示邮箱重复</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证账号</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">u</span> <span class="operator">=</span> userMapper.selectByName(user.getUsername());</span><br><span class="line">    <span class="keyword">if</span>(u != <span class="literal">null</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;该账号已存在&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证邮箱</span></span><br><span class="line">    u = userMapper.selectByEmail(user.getEmail());</span><br><span class="line">    <span class="keyword">if</span>(u != <span class="literal">null</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;emailMsg&quot;</span>, <span class="string">&quot;该邮箱已被注册&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//注册用户</span></span><br><span class="line">    user.setSalt(CommunityUtil.generateUUID().substring(<span class="number">0</span>,<span class="number">5</span>));</span><br><span class="line">    user.setPassword(CommunityUtil.md5(user.getPassword() + user.getSalt()));</span><br><span class="line">    user.setType(<span class="number">0</span>);</span><br><span class="line">    user.setStatus(<span class="number">0</span>);</span><br><span class="line">    user.setActivationCode(CommunityUtil.generateUUID());</span><br><span class="line">    user.setHeaderUrl(String.format(<span class="string">&quot;http://images.nowcoder.com/head/%dt.png&quot;</span>, <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>)));</span><br><span class="line">    user.setCreateTime(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line"></span><br><span class="line">    userMapper.insertUser(user);<span class="comment">//这里因为我们配置文件要求mybatis自动生成id，所以不需要我们显示为id赋值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//激活邮件</span></span><br><span class="line">    <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Context</span>();<span class="comment">//这里的Context类属于org.thymeleaf.context的Context</span></span><br><span class="line">    context.setVariable(<span class="string">&quot;email&quot;</span>, user.getEmail());</span><br><span class="line">    <span class="comment">// http://localhost:8080/community/activation/101/code</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> domain + contextPath + <span class="string">&quot;/activation/&quot;</span> + user.getId() + <span class="string">&quot;/&quot;</span> + user.getActivationCode();</span><br><span class="line">    context.setVariable(<span class="string">&quot;url&quot;</span>, url);</span><br><span class="line">    <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> templateEngine.process(<span class="string">&quot;/mail/activation&quot;</span>, context);</span><br><span class="line">    mailClient.sendMail(user.getEmail(), <span class="string">&quot;激活账号&quot;</span>, content);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-开发Controller层——LoginController处理注册请求"><a href="#4-开发Controller层——LoginController处理注册请求" class="headerlink" title="4.开发Controller层——LoginController处理注册请求"></a>4.开发Controller层——LoginController处理注册请求</h2><p>先把前面开发的UserService业务层注入进来</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220518221058302.png" alt="image-20220518221058302"></p>
<p>定义一个方法<strong>处理注册请求</strong>，浏览器要向服务器提交数据，肯定是POST请求</p>
<p>其实就是用业务层的map，如果<strong>map为空我们就可以发激活码</strong>了，表明成功，跳转到成功页面，然后过8秒跳到首页；如果map不为空，说明验证失败，就重新跳转到注册页面，并<strong>通过前端提示后端map传来的错误信息</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/register&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">register</span><span class="params">(Model model,User user)</span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = userService.register(user);</span><br><span class="line">    <span class="keyword">if</span>(map == <span class="literal">null</span> || map.isEmpty())&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;注册成功，我们已经向您的邮箱发送了一封激活邮件，请尽快激活！&quot;</span>);</span><br><span class="line">        <span class="comment">//倒计时之后要跳转到首页</span></span><br><span class="line">        model.addAttribute(<span class="string">&quot;target&quot;</span>, <span class="string">&quot;/index&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/operate-result&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;usernameMsg&quot;</span>, map.get(<span class="string">&quot;usernameMsg&quot;</span>));</span><br><span class="line">        model.addAttribute(<span class="string">&quot;passwordMsg&quot;</span>, map.get(<span class="string">&quot;passwordMsg&quot;</span>));</span><br><span class="line">        model.addAttribute(<span class="string">&quot;emailMsg&quot;</span>, map.get(<span class="string">&quot;emailMsg&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/register&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="5-定义常量接口——CommunityConstant"><a href="#5-定义常量接口——CommunityConstant" class="headerlink" title="5.定义常量接口——CommunityConstant"></a>5.定义常量接口——CommunityConstant</h2><p>该接口专门定义一些常量，后面哪个类需要用到这些常量直接实现这些接口即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CommunityConstant</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 激活成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ACTIVATION_SUCCESS</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重复激活</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ACTIVATION_REPEAT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 激活失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ACTIVATION_FAILURE</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-开发Service层——还是UserService处理激活账号业务"><a href="#6-开发Service层——还是UserService处理激活账号业务" class="headerlink" title="6.开发Service层——还是UserService处理激活账号业务"></a>6.开发Service层——还是UserService处理激活账号业务</h2><p>一共有三种结果：激活成功，重复激活，激活失败</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">activation</span><span class="params">(<span class="type">int</span> userId, String code)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(userId);</span><br><span class="line">    <span class="keyword">if</span>(user.getStatus() == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_REPEAT;<span class="comment">//如果用户状态已经为1，说明当前是重复激活</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(user.getActivationCode().equals(code))&#123;</span><br><span class="line">        userMapper.updateStatus(userId, <span class="number">1</span>);<span class="comment">//如果用户状态不为1，而且当前激活码满足条件，就把状态设为1</span></span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_SUCCESS;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ACTIVATION_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-开发激活控制层Controller——还是LoginController"><a href="#7-开发激活控制层Controller——还是LoginController" class="headerlink" title="7.开发激活控制层Controller——还是LoginController"></a>7.开发激活控制层Controller——还是LoginController</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://localhost:8080/community/activation/101/code</span></span><br><span class="line">  <span class="meta">@RequestMapping(path = &quot;/activation/&#123;userId&#125;/&#123;code&#125;&quot;, method = RequestMethod.GET)</span></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">activation</span><span class="params">(Model model, <span class="meta">@PathVariable(&quot;userId&quot;)</span> <span class="type">int</span> userId, <span class="meta">@PathVariable(&quot;code&quot;)</span> String code)</span>&#123;</span><br><span class="line">      <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userService.activation(userId, code);</span><br><span class="line">      <span class="comment">//激活成功了就返回登录页面</span></span><br><span class="line">      <span class="keyword">if</span>(result == ACTIVATION_SUCCESS)&#123;</span><br><span class="line">          model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;激活成功，您的账号已经可以正常使用了！&quot;</span>);</span><br><span class="line">          model.addAttribute(<span class="string">&quot;target&quot;</span>, <span class="string">&quot;/login&quot;</span>);</span><br><span class="line">      <span class="comment">//重复激活或失败了都返回主页</span></span><br><span class="line">      &#125;<span class="keyword">else</span> <span class="keyword">if</span>(result == ACTIVATION_REPEAT)&#123;</span><br><span class="line">          model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;无效操作，该账号已经激活过了！&quot;</span>);</span><br><span class="line">          model.addAttribute(<span class="string">&quot;target&quot;</span>, <span class="string">&quot;/index&quot;</span>);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          model.addAttribute(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;激活失败，您提供的激活码不正确！&quot;</span>);</span><br><span class="line">          model.addAttribute(<span class="string">&quot;target&quot;</span>, <span class="string">&quot;/index&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;/site/operate-result&quot;</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>因为激活方法中返回登陆页面，我们还没写登陆页面的方法，所以下面写getLogin方法</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220519161309172.png" alt="image-20220519161309172"></p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>注册功能的实现肯定底层逻辑是先验证当前的用户名，密码和邮箱<strong>是否合法</strong>（包括空值和是否在库的情况）。通过了这些合法性验证，我们就可以<strong>给用户的信息存储到数据库</strong>中，但是存储过程中，我们需要<strong>给用户的密码加密</strong>，否则很容易被盗。所以我们需要写个工具专门给字符串进行加密。但是加密入md5对简单字符串加密是对称加密，所以我们还需要在这些<strong>密码的基础上加点salt</strong>，这些salt我们用随机字符串来表示。所以还需要写个生成随机字符串的方法，我们<strong>用lang3包下的工具类</strong>实现。注册完成之后，就可以通过系统邮箱发邮件和激活码了，激活码我们也用随机字符串方法生成。OK，注册业务逻辑写完（伴随工具类的开发）。</p>
<p>注册业务逻辑写完了，视图层就可以调用该方法了，业务中报的错误我们都传给model，由<strong>model传给前端</strong>，然后<strong>跳转到注册页面并报错</strong>；如果没错，我们就<strong>跳到激活页面</strong>，倒计时之后<strong>转到首页</strong>。</p>
<p>激活完了有三种情况：成功，失败和重复激活。我们把这仨情况写到常量接口中，<strong>后面业务层和控制层要复用</strong>。然后写业务逻辑，说白了就是三种情况我们分别要干什么，<strong>后面控制层收到才可以进一步操作</strong>。处理完了就可以写控制层，根据激活业务<strong>返回的激活状态</strong>，将<strong>激活信息传给model</strong>，并<strong>确定每种情况要返回的页面</strong>。</p>
<h1 id="2-17-生成验证码"><a href="#2-17-生成验证码" class="headerlink" title="2.17 生成验证码"></a>2.17 生成验证码</h1><h2 id="1-导入Kaptcha包"><a href="#1-导入Kaptcha包" class="headerlink" title="1.导入Kaptcha包"></a>1.导入Kaptcha包</h2><p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220519185233228.png" alt="image-20220519185233228"></p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220519185721410.png" alt="image-20220519185721410"></p>
<h2 id="2-将kaptcha注入Spring容器——KaptchaConfig"><a href="#2-将kaptcha注入Spring容器——KaptchaConfig" class="headerlink" title="2.将kaptcha注入Spring容器——KaptchaConfig"></a>2.将kaptcha注入Spring容器——KaptchaConfig</h2><p>在config包下写配置类KaptchaConfig，<strong>通过配置类Properties直接写入验证码的参数</strong>：如宽度，高度，字体大小，颜色，字符范围，字符数量，干扰项。然后把配置类信息<strong>赋予kaptcha的Config类</strong>，然后<strong>传给DefaultKaptcha类</strong>。</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220519190503946.png" alt="image-20220519190503946"></p>
<h2 id="3-开发Controller层——LoginController生成验证码的方法"><a href="#3-开发Controller层——LoginController生成验证码的方法" class="headerlink" title="3.开发Controller层——LoginController生成验证码的方法"></a>3.开发Controller层——LoginController生成验证码的方法</h2><p>接下来就要把验证码应用到登录功能中，没有业务逻辑（与数据库交互），所以直接写控制层逻辑。</p>
<p>写在哪呢，访问登录页面的方法会返回一个html页面（<u>&#x2F;site&#x2F;login</u>），<strong>此页面中有访问验证码的路径</strong>，浏览器<strong>通过该路径访问服务器</strong>，才获得验证码图片。</p>
<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220519201235211.png" alt="image-20220519201235211"></p>
<p>因为我们要访问一个特殊的数据——图片，所以不设置返回值，直接通过response手动地向浏览器输出，同时也要把验证码的字符串内容存入服务器端session（存在浏览器端cookie容易被盗取）。最后不要忘了注入刚刚写的配置类kaptchaProducer。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/kaptcha&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getKaptcha</span><span class="params">(HttpServletResponse response, HttpSession session)</span>&#123;</span><br><span class="line">    <span class="comment">//生成验证码</span></span><br><span class="line">    <span class="comment">//生成验证码字符串</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">text</span> <span class="operator">=</span> kaptchaProducer.createText();</span><br><span class="line">    <span class="comment">//生成验证码图片</span></span><br><span class="line">    <span class="type">BufferedImage</span> <span class="variable">image</span> <span class="operator">=</span> kaptchaProducer.createImage(text);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将验证码存入session</span></span><br><span class="line">    session.setAttribute(<span class="string">&quot;kaptcha&quot;</span>, text);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将图片输出给浏览器</span></span><br><span class="line">    response.setContentType(<span class="string">&quot;image/png&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//获取response输出流（字节流）向浏览器响应</span></span><br><span class="line">        <span class="type">OutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        <span class="comment">//用javax工具类输出图片</span></span><br><span class="line">        ImageIO.write(image, <span class="string">&quot;png&quot;</span>, os);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        logger.error(<span class="string">&quot;响应验证码失败：&quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-23-开发登录、退出功能"><a href="#2-23-开发登录、退出功能" class="headerlink" title="2.23 开发登录、退出功能"></a>2.23 开发登录、退出功能</h1><p>大纲如下：</p>
<img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220519204318213.png" alt="image-20220519204318213" style="zoom:50%;" />

<h2 id="1-创建实体类entity——LoginTicket"><a href="#1-创建实体类entity——LoginTicket" class="headerlink" title="1.创建实体类entity——LoginTicket"></a>1.创建实体类entity——LoginTicket</h2><p>我们把登录的用户信息单独存在一张数据库表里，字段分别有序号id, 用户序号user_id, 登陆凭证ticket, 用户登陆状态status, 用户登录过期时间expired</p>
<h2 id="2-开发DAO数据访问层——LoginTicketMapper"><a href="#2-开发DAO数据访问层——LoginTicketMapper" class="headerlink" title="2.开发DAO数据访问层——LoginTicketMapper"></a>2.开发DAO数据访问层——LoginTicketMapper</h2><p>插入一条数据，<strong>根据登陆凭证ticket查询数据</strong>，<strong>根据ticket更新登录状态</strong>（失效，有效）</p>
<p>上次用的xml的格式写的sql，本次<strong>用注解的方式</strong>写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">LoginTicketMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Insert(&#123;</span></span><br><span class="line"><span class="meta">            &quot;insert into login_ticket(user_id,ticket,status,expired) &quot;,</span></span><br><span class="line"><span class="meta">            &quot;values(#&#123;userId&#125;,#&#123;ticket&#125;,#&#123;status&#125;,#&#123;expired&#125;)&quot;</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="meta">@Options(useGeneratedKeys = true, keyProperty = &quot;id&quot;)</span><span class="comment">//设置id是自增的</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">insertLoginTicket</span><span class="params">(LoginTicket loginTicket)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&#123;</span></span><br><span class="line"><span class="meta">            &quot;select id,user_id,ticket,status,expired &quot;,</span></span><br><span class="line"><span class="meta">            &quot;from login_ticket where ticket=#&#123;ticket&#125;&quot;</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    LoginTicket <span class="title function_">selectByTicket</span><span class="params">(String ticket)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Update(&#123;</span></span><br><span class="line"><span class="meta">            &quot;update login_ticket set status=#&#123;status&#125; where ticket=#&#123;ticket&#125;&quot;</span></span><br><span class="line"><span class="meta">    &#125;)</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">updateStatus</span><span class="params">(<span class="meta">@Param(&quot;ticket&quot;)</span> String ticket, <span class="meta">@Param(&quot;status&quot;)</span> <span class="type">int</span> status)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-开发Service层——登录业务UserService"><a href="#3-开发Service层——登录业务UserService" class="headerlink" title="3.开发Service层——登录业务UserService"></a>3.开发Service层——登录业务UserService</h2><p>先把刚才的LoginTicketMapper组件注入进来，然后再开始实现登录功能。因为登录也会像注册一样，可能有很多报错，所以<strong>返回值为Map类型数据用来存储报错信息</strong>。</p>
<p>另外，登录功能可以肯定的是<strong>需要我们传入用户名和密码，还有过期时间也要传入</strong>，这个容易忘记！！！</p>
<p>具体功能和注册功能的业务逻辑很像，首先判断空值，然后验证合法性（<strong>注意密码要加salt</strong>），都通过了就生成登陆凭证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">login</span><span class="params">(String username, String password, <span class="type">int</span> expiredSeconds)</span>&#123;</span><br><span class="line">    Map&lt;String, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//空值处理</span></span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(username))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;账号不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(password))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;passwordMsg&quot;</span>, <span class="string">&quot;密码不能为空！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证账号</span></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectByName(username);</span><br><span class="line">    <span class="keyword">if</span>(user == <span class="literal">null</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;该账号不存在！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证状态（注册后有没有激活）</span></span><br><span class="line">    <span class="keyword">if</span>(user.getStatus() == <span class="number">0</span>)&#123;</span><br><span class="line">        map.put(<span class="string">&quot;usernameMsg&quot;</span>, <span class="string">&quot;该账号未激活！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//验证密码</span></span><br><span class="line">    password = CommunityUtil.md5(password + user.getSalt());</span><br><span class="line">    <span class="keyword">if</span>(!user.getPassword().equals(password))&#123;</span><br><span class="line">        map.put(<span class="string">&quot;passwordMsg&quot;</span>, <span class="string">&quot;密码不正确！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//生成登录凭证</span></span><br><span class="line">    <span class="type">LoginTicket</span> <span class="variable">loginTicket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginTicket</span>();</span><br><span class="line">    loginTicket.setUserId(user.getId());</span><br><span class="line">    loginTicket.setTicket(CommunityUtil.generateUUID());</span><br><span class="line">    loginTicket.setStatus(<span class="number">0</span>);</span><br><span class="line">    loginTicket.setExpired(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis() + expiredSeconds * <span class="number">1000</span>));</span><br><span class="line">    loginTicketMapper.insertLoginTicket(loginTicket);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//也可以传入loginTicket整个对象，但没必要，我们只需要登陆凭证，其他的登录信息可以用凭证去库里查</span></span><br><span class="line">    map.put(<span class="string">&quot;ticket&quot;</span>, loginTicket.getTicket());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4-开发Controller——登录功能login"><a href="#4-开发Controller——登录功能login" class="headerlink" title="4.开发Controller——登录功能login"></a>4.开发Controller——登录功能login</h2><p>这里返回页面也是&#x2F;login，不会与前面的返回&#x2F;login页面的方法冲突是因为，<strong>前面是get请求，当前方法是post请求。</strong></p>
<p>传入的参数分别有用户名，密码，因为<strong>要与页面直接交互</strong>了，所以还有<strong>验证码code</strong>，因为<strong>验证码要去session中取</strong>，所以要有Session session，另外还有<strong>页面上的选框“记住我”rememberme</strong>，如果登录成功，要<strong>将ticket登陆凭证存入浏览器的cookie</strong>中，所以要用response接收，最后别忘了Model <strong>model</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/login&quot;, method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">login</span><span class="params">(String username, String password, String code, <span class="type">boolean</span> rememberme,</span></span><br><span class="line"><span class="params">                    Model model, HttpSession session, HttpServletResponse response)</span>&#123;</span><br><span class="line">    <span class="comment">//检查验证码</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">kaptcha</span> <span class="operator">=</span> (String) session.getAttribute(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code))&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;codeMsg&quot;</span>, <span class="string">&quot;验证码不正确！&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/login&quot;</span>;<span class="comment">//回到登录页面</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//检查账号，密码</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">expiredSeconds</span> <span class="operator">=</span> rememberme ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS;</span><br><span class="line">    Map&lt;String, Object&gt; map = userService.login(username, password, expiredSeconds);</span><br><span class="line">    <span class="keyword">if</span>(map.containsKey(<span class="string">&quot;ticket&quot;</span>))&#123;</span><br><span class="line">        <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;ticket&quot;</span>, map.get(<span class="string">&quot;ticket&quot;</span>).toString());</span><br><span class="line">        <span class="comment">//生成cookie有效路径</span></span><br><span class="line">        cookie.setPath(contextPath);</span><br><span class="line">        <span class="comment">//设置cookie有效时间</span></span><br><span class="line">        cookie.setMaxAge(expiredSeconds);</span><br><span class="line">        <span class="comment">//将cookie加入到response中，响应时就会将cookie发送给浏览器</span></span><br><span class="line">        response.addCookie(cookie);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/index&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;usernameMsg&quot;</span>, map.get(<span class="string">&quot;usernameMsg&quot;</span>));</span><br><span class="line">        model.addAttribute(<span class="string">&quot;passwordMsg&quot;</span>, map.get(<span class="string">&quot;passwordMsg&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/site/login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在“记住我”选框判断的时候，需要利用常量接口中的两个属性，要记得在接口中加上：</p>
<img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220519215357488.png" alt="image-20220519215357488" style="zoom: 67%;" />

<h2 id="5-开发Service层——退出业务logout"><a href="#5-开发Service层——退出业务logout" class="headerlink" title="5.开发Service层——退出业务logout"></a>5.开发Service层——退出业务logout</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(String ticket)</span>&#123;<span class="comment">//传入凭证即可</span></span><br><span class="line">    loginTicketMapper.updateStatus(ticket, <span class="number">1</span>);<span class="comment">//将用户状态改为1即可</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-开发Controller层——退出功能logout"><a href="#6-开发Controller层——退出功能logout" class="headerlink" title="6.开发Controller层——退出功能logout"></a>6.开发Controller层——退出功能logout</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(path = &quot;/logout&quot;, method = RequestMethod.GET)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">logout</span><span class="params">(<span class="meta">@CookieValue(&quot;ticket&quot;)</span> String ticket)</span>&#123;</span><br><span class="line">    userService.logout(ticket);</span><br><span class="line">    <span class="comment">//重定向到登陆页面</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;redirect:/login&quot;</span>;<span class="comment">//重定向默认是GET请求的/login</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="2-27-显示登录信息（头部信息）"><a href="#2-27-显示登录信息（头部信息）" class="headerlink" title="2.27 显示登录信息（头部信息）"></a>2.27 显示登录信息（头部信息）</h1><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220520165750148.png" alt="image-20220520165750148" style="zoom: 67%;" />

<p><img src="C:\Users\Reex\AppData\Roaming\Typora\typora-user-images\image-20220520170844188.png" alt="image-20220520170844188"></p>
<p>以上的过程我们通过拦截器来实现。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2022/05/13/%E6%88%91%E7%9A%84%E9%A1%B9%E7%9B%AE/" data-id="cl34jfrpo0000agv65zyw0788" data-title="我的项目" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/05/14/%E6%A0%88%E4%B8%8E%E9%98%9F%E5%88%97%E9%A2%98%E8%A7%A3/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          栈与队列题解
        
      </div>
    </a>
  
  
    <a href="/2022/05/13/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">计算机网络笔记</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/05/17/%E4%BA%8C%E5%8F%89%E6%A0%91%E9%A2%98%E8%A7%A3/">二叉树题解</a>
          </li>
        
          <li>
            <a href="/2022/05/15/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9/">Java基础知识点</a>
          </li>
        
          <li>
            <a href="/2022/05/14/%E6%A0%88%E4%B8%8E%E9%98%9F%E5%88%97%E9%A2%98%E8%A7%A3/">栈与队列题解</a>
          </li>
        
          <li>
            <a href="/2022/05/13/%E6%88%91%E7%9A%84%E9%A1%B9%E7%9B%AE/">我的项目</a>
          </li>
        
          <li>
            <a href="/2022/05/13/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0/">计算机网络笔记</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>